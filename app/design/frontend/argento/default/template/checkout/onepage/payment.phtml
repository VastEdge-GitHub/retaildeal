<?php 
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2012 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
$quote = Mage::getSingleton('checkout/session')->getQuote();
 //echo $quote->getItemsQty(); 
function qty_check()
{
$itemsCollection = Mage::getSingleton('checkout/session')->getQuote()->getItemsCollection();
$itemsVisible = Mage::getSingleton('checkout/session')->getQuote()->getAllVisibleItems();
$items = Mage::getSingleton('checkout/session')->getQuote()->getAllItems(); 
foreach($items as $item) {
	
if($item->getQty()>1){return 1;}
			
else
{
	return 0;
}
}
}
?>

<!--- start for segment io tracking---->
<script type="text/javascript">
analytics.track('Cart', {
  Action: 'SpecifiesShippingInformation'
});
</script>
<script type="text/javascript">
//<![CDATA[
    var quoteBaseGrandTotal = <?php echo (float)$this->getQuoteBaseGrandTotal(); ?>;
    var checkQuoteBaseGrandTotal = quoteBaseGrandTotal;
    var payment = new Payment('co-payment-form', '<?php echo $this->getUrl('checkout/onepage/savePayment') ?>');
    var lastPrice;
//]]>
</script>
<!-- Changes made by liki ext -->
<script>
function check_liki_price()
{
	//RD-220 
	var quoteBaseGrandTotal = <?php echo (float)$this->getQuoteBaseGrandTotal(); ?>;
	var option_newcase = document.getElementsByTagName("input");
	var option_newcase_value;
	for(var i = 0; i < option_newcase.length; i++){
		if(option_newcase[i].checked){
			option_newcase_value = option_newcase[i].value;
		}
	}
		var e = document.getElementById("billing-address-select");
		if(e)
		{
			var billing_address_no = e.options[e.selectedIndex].value;
			var custom_billing_address = e.options[e.selectedIndex].text;
			if(custom_billing_address=='New Address')
			{
				var e 			= document.getElementById("billing-address-select");
				var fn 			= document.getElementById("billing:firstname").value;
				var ln			= document.getElementById("billing:lastname").value;
				var company 	= document.getElementById("billing:company").value;
				var street1 	= document.getElementById("billing:street1").value;
				var street2 	= document.getElementById("billing:street2").value;
				var city 		= document.getElementById("billing:city").value;
				var region_id 	= document.getElementById("billing:region_id").value;
				var postcode 	= document.getElementById("billing:postcode").value;
				var country_id 	= document.getElementById("billing:country_id").value;
				var telephone 	= document.getElementById("billing:telephone").value;
				var fax 		= document.getElementById("billing:fax").value;
				var custom_billing_address = fn+ln+company+street1+street2+city+region_id+postcode+country_id+telephone+fax;
			}
		}

		
		
		var e = document.getElementById("shipping-address-select");
		if(e)
		{
			var shipping_address_no = e.options[e.selectedIndex].value;
			var custom_shipping_address = e.options[e.selectedIndex].text;
			if(custom_shipping_address=='New Address')
			{
				var fn 			= document.getElementById("shipping:firstname").value;
				var ln 			= document.getElementById("shipping:lastname").value;
				var company 	= document.getElementById("shipping:company").value;
				var street1 	= document.getElementById("shipping:street1").value;
				var street2 	= document.getElementById("shipping:street2").value;
				var city 		= document.getElementById("shipping:city").value;
				var region_id 	= document.getElementById("shipping:region_id").value;
				var postcode 	= document.getElementById("shipping:postcode").value;
				var country_id 	= document.getElementById("shipping:country_id").value;
				var telephone 	= document.getElementById("shipping:telephone").value;
				var fax 		= document.getElementById("shipping:fax").value;
				var custom_shipping_address = fn+ln+company+street1+street2+city+region_id+postcode+country_id+telephone+fax;
			}
		}
		var off_payment_method = document.getElementsByName('payment[method]');
		for ( var i = 0; i < off_payment_method.length; i++)
		{
			if(off_payment_method[i].checked)
			{	
				if(off_payment_method[i].value=='firstdataglobalgateway'){alert("We're not currently accepting credit card transactions."); return false;}
				if(off_payment_method[i].value!='CreditApplication') 
				{	
					if(custom_shipping_address!=custom_billing_address || billing_address_no!=shipping_address_no)
					{ 
						alert('Billing and Shipping destinations need to be the same when using the Credit Card option.');
						return false;
					}
				}
			}
		}
	if(option_newcase_value == 'CreditApplication'){
	var qty_check = '<?php $itemsCollection = Mage::getSingleton('checkout/session')->getQuote()->getItemsCollection();
$itemsVisible = Mage::getSingleton('checkout/session')->getQuote()->getAllVisibleItems();
$items = Mage::getSingleton('checkout/session')->getQuote()->getAllItems();
$qty=0; 
foreach($items as $item) {
	
if($item->getQty()>1){ $qty=1;echo $qty;}
			
else
{
	
}
}
 ?>';
//alert(qty_check);
if(qty_check > 0)
{
	alert('We apologize but LeaseItKeepIt does not allow multiple quantity of the same item. We are working to provide this service soon.');
return false;
}	 
	 }
	if(option_newcase_value == 'CreditApplication' && quoteBaseGrandTotal < 100)
	{
		alert('Total Amount cannot be less than $100 for LIKI payment mode.');
		return false;
	}
	else
	{
		return true;
	}
	
	
}
</script>
<!-- Changes made by liki ext end -->
<form action="" id="co-payment-form">
    <fieldset>
        <?php echo $this->getChildHtml('methods') ?>
    </fieldset>
</form>

<div class="tool-tip" id="payment-tool-tip" style="display:none;">
    <div class="btn-close"><a href="#" id="payment-tool-tip-close" title="<?php echo $this->__('Close') ?>"><?php echo $this->__('Close') ?></a></div>
    <div class="tool-tip-content"><img src="<?php echo $this->getSkinUrl('images/cvv.gif') ?>" alt="<?php echo $this->__('Card Verification Number Visual Reference') ?>" title="<?php echo $this->__('Card Verification Number Visual Reference') ?>" /></div>
</div>
<div class="buttons-set" id="payment-buttons-container">
	<!--LIKI Code start Reason: RD-158 -->
    <?php
	$lastUrl = Mage::getSingleton('core/session')->getLastUrl();
	$url = Mage::getSingleton('core/url')->parseUrl($lastUrl);
	$path = $url->getPath();
    if (preg_match("#/CreditApplication/Payment/cancel/#", $path)) {?>
		<?php } else{?>
		<!--Remove back link-->
		<p class="back-link"><a href="#" onclick="checkout.back(); return false;"><small>&laquo; </small><?php echo $this->__('Back') ?></a></p>
		<?php } ?>
    <button type="button" class="button" onclick="if( check_liki_price() ) {payment.save();} test(this.id);"><span><span><?php echo $this->__('Continue') ?></span></span></button>
	<!--LIKI Code End-->
    <span class="please-wait" id="payment-please-wait" style="display:none;">
        <img src="<?php echo $this->getSkinUrl('images/opc-ajax-loader.gif') ?>" alt="<?php echo $this->__('Loading next step...') ?>" title="<?php echo $this->__('Loading next step...') ?>" class="v-middle" /> <?php echo $this->__('Loading next step...') ?>
    </span>
</div>
<script type="text/javascript">
//<![CDATA[
    function toggleToolTip(event){
        if($('payment-tool-tip')){
            $('payment-tool-tip').setStyle({
                top: (Event.pointerY(event)-560)+'px'//,
                //left: (Event.pointerX(event)+100)+'px'
            })
            $('payment-tool-tip').toggle();
        }
        Event.stop(event);
    }
    if($('payment-tool-tip-close')){
        Event.observe($('payment-tool-tip-close'), 'click', toggleToolTip);
    }
//]]>
</script>
<script type="text/javascript">
//<![CDATA[
    payment.currentMethod = "<?php echo $this->getChild('methods')->getSelectedMethodCode() ?>";
//]]>
<!--LIKI Code start Reason: RD-158 -->
function test(id)
{
	<?php
	$lastUrl = Mage::getSingleton('core/session')->getLastUrl();
	$url = Mage::getSingleton('core/url')->parseUrl($lastUrl);
	$path = $url->getPath();
    if (preg_match("#/CreditApplication/Payment/cancel/#", $path)) {?>
		setTimeout(function(){
		document.getElementById("opc-payment").className = "section allow";
		document.getElementById("opc-billing").className = "section allow";
		document.getElementById("checkout-step-payment").style.display = "none";
		},1100);	
	<?php } ?>	
}
<!--LIKI Code End-->
</script>

